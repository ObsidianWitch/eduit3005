\documentclass[frenchb, 11pt]{article}

\usepackage[top=2cm, bottom=2cm, left=2cm, right=2cm]{geometry}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{babel}

\usepackage{multicol}
\setlength{\columnseprule}{1pt} % separation line between columns

\usepackage{hyperref}
\hypersetup{
	colorlinks=true,	% false: boxed links; true: colored links
	linkcolor=black,	% color of internal links
	urlcolor=blue,		% color of external links
	citecolor=blue
}

\usepackage{graphicx}	% import graphics
\usepackage{wrapfig}	% wrap text around figures
\usepackage{subcaption}


\usepackage{verbatim}	% multi-line comments

% Colors
\usepackage[usenames,dvipsnames]{xcolor}

% Colored frame
\usepackage{framed}
\definecolor{shadecolor}{rgb}{0.96,0.96,0.96}
\definecolor{TFFrameColor}{rgb}{0.96,0.96,0.96}
\definecolor{TFTitleColor}{rgb}{0.00,0.00,0.00}

% Redefine leftbar envvironment
\newlength{\leftbarwidth}
\setlength{\leftbarwidth}{1pt}
\newlength{\leftbarsep}
\setlength{\leftbarsep}{10pt}

\newcommand*{\leftbarcolorcmd}{\color{leftbarcolor}} % as a command to be more flexible
\colorlet{leftbarcolor}{gray}

\renewenvironment{leftbar}{%
    \def\FrameCommand{{\leftbarcolorcmd{\vrule width \leftbarwidth\relax\hspace {\leftbarsep}}}}%
    \MakeFramed {\advance \hsize -\width \FrameRestore }%
}{%
    \endMakeFramed
}

% Code listings
\usepackage{listings}
\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}
\definecolor{blue}{rgb}{0,0,0.7}
\lstset{
	language=bash,
	basicstyle=\scriptsize,
	numbers=left,                   % where to put the line-numbers
  	numberstyle=\tiny\color{gray},
	commentstyle=\color{dkgreen},
	stringstyle=\color{BrickRed},
	backgroundcolor=\color{shadecolor},
    keywordstyle=\color{OliveGreen},
	frame=single,                   % adds a frame around the code
 	rulecolor=\color{black},
	emph={},
	emphstyle=\color{mauve},
	morekeywords={},
	keywordstyle={\color{black}},
	showstringspaces=false,
  	tabsize=4,
	moredelim=[is][\small\ttfamily]{/*}{*/}
}

% Title page
\title{
	\textbf{IT-3005 - TP Sécurité}\\
	DMZ / Firewall Linux
}
\date{\today}

\begin{document}
\maketitle
\newpage

%\tableofcontents
%\newpage

\section{Introduction}
% postes utilisés 10,11,12
% objectifs
% brève présentation du lab créé à l'aide de Netkit

\section{Câblage}
% TODO parler de mii-tool

\begin{figure}[h!]
	\centering
	\begin{subfigure}[b]{0.4\textwidth}
		\includegraphics[scale=0.80]{sch1.png}
		\caption{Séance}
	\end{subfigure}%
	~
	\begin{subfigure}[b]{0.4\textwidth}
	\includegraphics[scale=0.80]{sch2.png}
	\caption{Netkit}
	\label{fig:planadrnetkit}
	\end{subfigure}
	\caption{Plan d'adressage}
\end{figure}

\noindent \textbf{N.B.} Le rapport décrira les différentes étapes du TP en suivant le plan d'adressage de la figure \ref{fig:planadrnetkit} (Netkit).

% après câblage ping possibles: lan <-> routeur et dmz <-> routeur
% il faut activer le routage IP sur le routeur

\newpage

\section{Routage classique}
Nous avons tout d'abord configuré les interfaces Ethernet des 3 machines, ajouté les passerelles par défaut pour LAN et DMZ, et activé le routage IP (IP forwarding) pour le routeur. Le routage IP permet de prendre des décisions concernant le chemin qu'un paquet doit prendre entre les différents réseaux.

\subsection{Configuration du PC Routeur}
% TODO coloration syntaxique
\begin{lstlisting}
/*Router:~#*/ echo "1" > /proc/sys/net/ipv4/ip_forward
/*Router:~#*/ ifconfig eth1 192.168.1.2 netmask 255.255.255.0 up
/*Router:~#*/ ifconfig eth2 192.168.2.2 netmask 255.255.255.0 up

/*Router:~#*/ ifconfig
eth0      Link encap:Ethernet  HWaddr 76:f5:98:50:22:50
          inet addr:10.0.0.2  Bcast:10.255.255.255  Mask:255.0.0.0
          ...

eth1      Link encap:Ethernet  HWaddr 7e:a1:77:92:58:e8
          inet addr:192.168.1.2  Bcast:192.168.1.255  Mask:255.255.255.0
          ...

eth2      Link encap:Ethernet  HWaddr 0e:bd:8c:c5:14:02
          inet addr:192.168.2.2  Bcast:192.168.2.255  Mask:255.255.255.0
          ...

/*Router:~#*/ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.2.0     0.0.0.0         255.255.255.0   U     0      0        0 eth2
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 eth1
10.0.0.0        0.0.0.0         255.0.0.0       U     0      0        0 eth0
0.0.0.0         10.0.0.1        0.0.0.0         UG    0      0        0 eth0
\end{lstlisting}
\hfill

\begin{leftbar}
\noindent Q1. Le répertoire \textbf{/proc/sys} contient des fichiers et sous-répertoires permettant d'activer ou désactiver immédiatement des fonctionnalités du kernel. Le répertoire \textbf{/proc/sys/net} concerne des fonctionnalités réseau, et \textbf{/proc/sys/net/ipv4} concerne plus particulièrement les fonctionnalités liées au protocole IPv4. Par exemple, le fichier \textbf{/proc/sys/net/ipv4/ip\_forward} permet d'activer le routage. Le fichier \textbf{/proc/sys/net/ipv4/icmp\_echo\_ignore\_all} permet d'ignorer les requêtes ECHO du protocole ICMP, ainsi la commande \emph{ping} utilisant ce protocole voit ses requêtes ignorées par une machine ayant \emph{icmp\_echo\_ignore\_all} activé.
% TODO serveurs actifs netstat
\end{leftbar}

\subsection{Configuration du PC LAN}
\begin{lstlisting}
/*LAN:~#*/ ifconfig eth0 down
/*LAN:~#*/ ifconfig eth1 192.168.1.1 netmask 255.255.255.0 up
/*LAN:~#*/ route add default gw 192.168.1.2 eth1

/*LAN:~#*/ ifconfig
eth1      Link encap:Ethernet  HWaddr 42:a7:57:d3:a5:1b
          inet addr:192.168.1.1  Bcast:192.168.1.255  Mask:255.255.255.0
          ...

/*LAN:~#*/ route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.1.0     *               255.255.255.0   U     0      0        0 eth1
default         192.168.1.2     0.0.0.0         UG    0      0        0 eth1

/*LAN:~#*/ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 eth1
0.0.0.0         192.168.1.2     0.0.0.0         UG    0      0        0 eth1
\end{lstlisting}

\subsection{Configuration du PC DMZ}
\begin{lstlisting}
/*DMZ:~#*/ ifconfig eth0 down
/*DMZ:~#*/ ifconfig eth1 192.168.2.1 netmask 255.255.255.0 up
/*DMZ:~#*/ route add default gw 192.168.2.2 eth1

/*DMZ:~#*/ ifconfig
eth1      Link encap:Ethernet  HWaddr 86:e8:ec:bc:60:67
          inet addr:192.168.2.1  Bcast:192.168.2.255  Mask:255.255.255.0
          ...
\end{lstlisting}
\newpage

\subsection{Tables de routage}
\begin{leftbar}
	\noindent Q2. La commande \emph{route -n} permet d'afficher la table de routage IP en remplaçant les noms d'hôtes (provenant par exemple du fichier /etc/hosts) par des adresses numériques. Le symbole * est remplacé par \emph{0.0.0.0}, ce qui désigne la route par défaut. Les tables de routage sur les machines LAN, DMZ et Routeur sont les suivantes :
	\begin{lstlisting}[caption=Table de routage LAN, numbers=none]
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 eth1
0.0.0.0         192.168.1.2     0.0.0.0         UG    0      0        0 eth1
	\end{lstlisting}
	\begin{lstlisting}[caption=Table de routage DMZ, numbers=none]
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.2.0     0.0.0.0         255.255.255.0   U     0      0        0 eth1
0.0.0.0         192.168.2.2     0.0.0.0         UG    0      0        0 eth1
	\end{lstlisting}
	\begin{lstlisting}[caption=Table de routage Routeur, numbers=none]
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.2.0     0.0.0.0         255.255.255.0   U     0      0        0 eth2
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 eth1
10.0.0.0        0.0.0.0         255.0.0.0       U     0      0        0 eth0
0.0.0.0         10.0.0.1        0.0.0.0         UG    0      0        0 eth0
	\end{lstlisting}
\end{leftbar}

\noindent Suite aux configurations effectuées précédemment, il est possible d'effectuer des pings entre les 3 machines.

\subsection{Configuration du serveur web sur le PC DMZ}
Nous souhaitons ensuite modifier la configuration du serveur http Apache (httpd) pour remplacer le port d'écoute par défaut 80 par le port 8080. Pour cela nous avons modifié le fichier suivant.
\begin{lstlisting}[caption=/etc/httpd/conf/httpd.conf]
Listen 8080
\end{lstlisting}
\hfill

\noindent \textbf{N.B.} Sous une machine (Debian testing) créée à l'aide de netkit utilisant le package apache2 et une configuration par défaut, nous avons dû modifier les fichiers \textbf{/etc/apache2/ports.conf} et \textbf{/etc/apache2/sites-enabled/000-default}. Le premier fichier nous a permis de remplacer le port d'écoute par défaut, le second de modifier le port du VirtualHost (les serveurs virtuels permettent de faire fonctionner plusieurs serveurs web sur une même machine, ici nous n'avons qu'un seul VirtualHost que nous souhaitons associé au port 8080).

\begin{lstlisting}[caption=/etc/apache2/ports.conf, escapechar=@]
# If you just change the port or add more ports here, you will likely also
# have to change the VirtualHost statement in
# /etc/apache2/sites-enabled/000-default
# This is also true if you have upgraded from before 2.2.9-3 (i.e. from
# Debian etch). See /usr/share/doc/apache2.2-common/NEWS.Debian.gz and
# README.Debian.gz

@\textbf{NameVirtualHost *:8080}@
@\textbf{Listen 8080}@

<IfModule mod_ssl.c>
    # SSL name based virtual hosts are not yet supported, therefore no
    # NameVirtualHost statement here
    Listen 443
</IfModule>
\end{lstlisting}

\begin{lstlisting}[caption=/etc/apache2/sites-enabled/000-default, escapechar=\%]
%\textbf{<VirtualHost *:8080>}%
        ServerAdmin webmaster@localhost

        DocumentRoot /var/www/
        <Directory />
                Options FollowSymLinks
                AllowOverride None
        </Directory>
		...
\end{lstlisting}

\noindent Une fois les fichiers de configuration modifiés, il faut relancer le serveur web :
\begin{lstlisting}
/etc/init.d/httpd restart

OU (en fonction de la distribution)

/etc/init.d/apache2 restart
\end{lstlisting}
\hfill

\noindent On peut ensuite vérifier à l'aide de la commande ps que le serveur est bien lancé :
\begin{lstlisting}
/*DMZ:~#*/ ps aux | grep apache
root      1010  0.0  8.4  13136  2736 ?        Ss   20:47   0:00 /usr/sbin/apache2 -k start
www-data  1011  0.0  5.9  12908  1928 ?        S    20:47   0:00 /usr/sbin/apache2 -k start
www-data  1013  0.0 10.3 234696  3352 ?        Sl   20:47   0:00 /usr/sbin/apache2 -k start
www-data  1018  0.0 10.3 234696  3340 ?        Sl   20:47   0:00 /usr/sbin/apache2 -k start
root      1116  0.0  2.1   3476   680 tty0     S+   23:45   0:00 grep --color apache
\end{lstlisting}
\hfill

Ci-dessous deux captures d'écran (figures \ref{fig:sch3lan} et \ref{fig:sch3dmz}) de la machine LAN accédant à \textbf{192.168.2.1} (DMZ) sur le port 8080 avec le navigateur web Lynx, et de la machine DMZ observant les paquets reçus sur son interface eth1. Le routeur achemine les paquets de la machine LAN vers la machine DMZ (192.168.1.1:59904 > 192.168.2.1:8080), puis la machine DMZ répond aux requêtes de la machine LAN en envoyant les paquets sur l'interface du routeur à laquelle elle est connectée (192.168.2.1:8080 > 192.168.1.1:59904).

\begin{figure}[h!]
	\centering
	\includegraphics[scale=0.62]{sch3LAN.png}
	\caption{Accès au serveur web (DMZ) depuis Lynx (LAN)}
	\label{fig:sch3lan}
\end{figure}
\newpage

\begin{figure}[h!]
	\centering
	\includegraphics[scale=0.68]{sch3DMZ.png}
	\caption{Paquets reçus par le serveur web (DMZ)}
	\label{fig:sch3dmz}
\end{figure}
\newpage

% TODO bibliography
\begin{thebibliography}{5}
\end{thebibliography}

\end{document}
